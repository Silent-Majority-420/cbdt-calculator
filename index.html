<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>BMDE Calculator - Cannabis Policy Analysis Tool with Federal Reform Impact</title>
    <meta name="title" content="BMDE Calculator - Cannabis Policy Analysis Tool with Federal Reform Impact">
    <meta name="description" content="Interactive Black Market Death Equation (BMDE) Framework calculator with 280E and SAFE Banking impact analysis. Validated predictive model with 5% mean absolute error across 24 U.S. markets.">
    <meta name="keywords" content="cannabis policy, BMDE framework, legal cannabis market, black market displacement, cannabis regulation, market analysis, 280E, SAFE Banking, federal cannabis reform">
    <meta name="author" content="Daniel Kief">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://dankreports.github.io/cbdt-calculator/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="BMDE Calculator - Cannabis Policy Analysis Tool">
    <meta property="og:description" content="Interactive tool for predicting legal cannabis market share with federal reform impact analysis (280E, SAFE Banking)">
    <meta property="og:image" content="https://dankreports.github.io/cbdt-calculator/og-image.jpg">
    <meta property="og:url" content="https://dankreports.github.io/cbdt-calculator/">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="BMDE Calculator">
    <meta name="twitter:description" content="Interactive cannabis policy analysis tool with federal reform impact">
    <meta name="twitter:image" content="https://dankreports.github.io/cbdt-calculator/twitter-image.jpg">
    
    <link rel="icon" type="image/png" href="logo.png">
    
    <!-- Schema.org Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "Person",
          "@id": "https://www.dankreports.com/about/#person",
          "name": "Daniel Kief",
          "url": "https://www.dankreports.com/about/",
          "image": {
            "@type": "ImageObject",
            "url": "https://www.dankreports.com/content/images/2025/12/Transparent-Logo-1.png"
          },
          "jobTitle": "Cannabis Policy Analyst & Researcher",
          "description": "Independent researcher specializing in cannabis market analysis, regulatory economics, and black market displacement dynamics.",
          "sameAs": [
            "https://orcid.org/0009-0003-1402-7503",
            "https://dataverse.harvard.edu/dataverse/danielkief",
            "https://github.com/Dan-K-Reports",
            "https://x.com/dankreports"
          ],
          "identifier": {
            "@type": "PropertyValue",
            "propertyID": "ORCID",
            "value": "0009-0003-1402-7503"
          }
        },
        {
          "@type": "Organization",
          "@id": "https://www.dankreports.com/#organization",
          "name": "Dan K Reports",
          "url": "https://www.dankreports.com",
          "logo": {
            "@type": "ImageObject",
            "url": "https://www.dankreports.com/content/images/2025/12/Transparent-Logo-min-1.png"
          },
          "description": "Independent cannabis policy research and market analysis",
          "founder": {
            "@id": "https://www.dankreports.com/about/#person"
          }
        },
        {
          "@type": "WebApplication",
          "name": "BMDE Calculator",
          "applicationCategory": "FinanceApplication",
          "operatingSystem": "Web",
          "description": "Interactive calculator for the Black Market Death Equation with federal reform impact analysis",
          "author": {
            "@id": "https://www.dankreports.com/about/#person"
          },
          "publisher": {
            "@id": "https://www.dankreports.com/#organization"
          },
          "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
          }
        }
      ]
    }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .validation-badge {
            display: inline-block;
            background: #48bb78;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            padding: 40px;
        }
        
        .section {
            background: #f7fafc;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        .section h2 {
            color: #2d3748;
            margin-bottom: 25px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .preset-button {
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .preset-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .preset-button:active {
            transform: translateY(0);
        }
        
        .lever-group {
            margin-bottom: 30px;
        }
        
        .lever-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .lever-value {
            color: #667eea;
            font-size: 1.1em;
        }
        
        .lever-description {
            font-size: 0.85em;
            color: #718096;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.5);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.5);
        }
        
        .results {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .result-main {
            font-size: 4em;
            font-weight: 700;
            margin: 20px 0;
        }
        
        .result-label {
            font-size: 1.2em;
            opacity: 0.95;
            margin-bottom: 15px;
        }
        
        .result-interpretation {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .utility-score {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
        }
        
        .reform-impact-box {
            background: #48bb78;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .reform-impact-box.active {
            display: block;
        }
        
        .reform-impact-title {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 12px;
        }
        
        .reform-impact-details {
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .reform-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .reform-stat {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 6px;
        }
        
        .reform-stat-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .reform-stat-value {
            font-size: 1.5em;
            font-weight: 700;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .checkbox-label:hover {
            border-color: #667eea;
            background: #f7fafc;
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        .checkbox-label input[type="checkbox"]:checked {
            background: #667eea;
        }
        
        .checkbox-text {
            flex: 1;
        }
        
        .checkbox-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .checkbox-desc {
            font-size: 0.85em;
            color: #718096;
            line-height: 1.4;
        }
        
        .info-section {
            background: #edf2f7;
            padding: 25px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .info-section h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .info-section p {
            line-height: 1.7;
            color: #4a5568;
            margin-bottom: 10px;
        }
        
        .info-section ul {
            margin-left: 20px;
            color: #4a5568;
            line-height: 1.7;
        }
        
        .citation {
            background: #2d3748;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .citation h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .citation a {
            color: #90cdf4;
            text-decoration: none;
            font-weight: 600;
        }
        
        .citation a:hover {
            text-decoration: underline;
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 968px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .reform-comparison {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            header {
                padding: 25px 20px;
            }
            
            header h1 {
                font-size: 1.8em;
            }
            
            header .subtitle {
                font-size: 1em;
            }
            
            .content {
                padding: 20px;
                gap: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .section h2 {
                font-size: 1.3em;
            }
            
            .preset-buttons {
                grid-template-columns: 1fr;
            }
            
            .result-main {
                font-size: 3em;
            }
            
            .lever-label {
                flex-direction: column;
                gap: 5px;
            }
        }
        
        @media (max-width: 480px) {
            header h1 {
                font-size: 1.5em;
            }
            
            .result-main {
                font-size: 2.5em;
            }
            
            .validation-badge {
                font-size: 0.8em;
                padding: 6px 12px;
            }
            
            .preset-button {
                padding: 14px;
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>BMDE Calculator</h1>
            <div class="subtitle">Black Market Death Equation</div>
            <div class="validation-badge">‚úì Validated: 3.8pp Average Error Across 6 Markets</div>
        </header>
        
        <div class="content">
            <!-- Left Column: Policy Levers -->
            <div>
                <div class="section">
                    <div class="preset-buttons">
                        <button class="preset-button" onclick="loadColoradoPreset()">Colorado (91%)</button>
                        <button class="preset-button" onclick="loadOregonPreset()">Oregon (100%)</button>
                        <button class="preset-button" onclick="loadWashingtonPreset()">Washington (76%)</button>
                        <button class="preset-button" onclick="loadIllinoisPreset()">Illinois (46%)</button>
                        <button class="preset-button" onclick="loadFloridaPreset()">Florida (33%)</button>
                        <button class="preset-button" onclick="resetToDefaults()">Typical Market</button>
                    </div>
                    
                    <h2>State Policy Levers</h2>
                    
                    <div class="lever-group">
                        <div class="lever-label">
                            <span>Price Gap (g)</span>
                            <span class="lever-value" id="priceDisplay">$0.00</span>
                        </div>
                        <div class="lever-description">
                            Legal vs. illicit price gap per gram. Negative = legal cheaper.
                        </div>
                        <input type="range" id="priceGap" min="-0.5" max="0.5" step="0.01" value="0" oninput="calculate()">
                    </div>
                    
                    <div class="lever-group">
                        <div class="lever-label">
                            <span>Access Density (D)</span>
                            <span class="lever-value" id="densityDisplay">0.50</span>
                        </div>
                        <div class="lever-description">
                            Dispensary density (stores per 100k residents, normalized)
                        </div>
                        <input type="range" id="density" min="-1" max="1" step="0.01" value="0.5" oninput="calculate()">
                    </div>
                    
                    <div class="lever-group">
                        <div class="lever-label">
                            <span>Safety/Quality (S)</span>
                            <span class="lever-value" id="safetyDisplay">0.50</span>
                        </div>
                        <div class="lever-description">
                            Testing requirements and product quality standards
                        </div>
                        <input type="range" id="safety" min="0" max="1" step="0.01" value="0.5" oninput="calculate()">
                    </div>
                    
                    <div class="lever-group">
                        <div class="lever-label">
                            <span>Convenience (F)</span>
                            <span class="lever-value" id="convenienceDisplay">0.50</span>
                        </div>
                        <div class="lever-description">
                            Operating hours, delivery, payment options
                        </div>
                        <input type="range" id="convenience" min="-1" max="1" step="0.01" value="0.5" oninput="calculate()">
                    </div>
                    
                    <div class="lever-group">
                        <div class="lever-label">
                            <span>Enforcement (E)</span>
                            <span class="lever-value" id="enforcementDisplay">0.50</span>
                        </div>
                        <div class="lever-description">
                            Illicit market enforcement intensity
                        </div>
                        <input type="range" id="enforcement" min="0" max="1" step="0.01" value="0.5" oninput="calculate()">
                    </div>
                    
                    <div class="lever-group" style="display: none;">
                        <div class="lever-label">
                            <span>Fragmentation (F_frag)</span>
                            <span class="lever-value" id="fragDisplay">0.00</span>
                        </div>
                        <div class="lever-description">
                            Local bans and market fragmentation
                        </div>
                        <input type="range" id="fragmentation" min="0" max="1" step="0.01" value="0" oninput="calculate()">
                    </div>
                </div>
                
                <div class="section" style="margin-top: 20px;">
                    <h2>Federal Reform Impact</h2>
                    
                    <label class="checkbox-label" for="remove280E">
                        <input type="checkbox" id="remove280E" onchange="calculate()">
                        <div class="checkbox-text">
                            <div class="checkbox-title">‚úì Eliminate IRS 280E Tax Code</div>
                            <div class="checkbox-desc">
                                Allows ordinary business expense deductions, reducing effective tax rates from 60-75% to 21%. Enables 20-30% consumer price reductions while maintaining operator margins.
                            </div>
                        </div>
                    </label>
                    
                    <label class="checkbox-label" for="safeBanking">
                        <input type="checkbox" id="safeBanking" onchange="calculate()">
                        <div class="checkbox-text">
                            <div class="checkbox-title">‚úì Pass SAFE Banking Act</div>
                            <div class="checkbox-desc">
                                Provides banking access, reducing operational costs by 15-25% (eliminates cash-only security, enables digital payments). Improves consumer convenience significantly.
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Right Column: Results -->
            <div>
                <div class="results">
                    <div class="result-label">Predicted Legal Market Share</div>
                    <div class="result-main" id="marketShare">50%</div>
                    <div class="utility-score">
                        Utility Score (ŒîU): <strong id="utilityScore">0.00</strong>
                    </div>
                    <div class="result-interpretation" id="interpretation">
                        Adjust the policy levers to see how different regulatory approaches affect legal market capture.
                    </div>
                    
                    <div class="reform-impact-box" id="reformImpactBox">
                        <div class="reform-impact-title">üéØ Federal Reform Impact</div>
                        <div class="reform-impact-details" id="reformImpactText"></div>
                        <div class="reform-comparison">
                            <div class="reform-stat">
                                <div class="reform-stat-label">Before Reforms</div>
                                <div class="reform-stat-value" id="beforeReform">--</div>
                            </div>
                            <div class="reform-stat">
                                <div class="reform-stat-label">After Reforms</div>
                                <div class="reform-stat-value" id="afterReform">--</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>About This Calculator</h2>
                    <div class="info-section">
                        <h3>The BMDE</h3>
                        <p>
                            The Black Market Death Equation (BMDE) is a validated economic model 
                            predicting legal cannabis market share based on five state policy levers and federal reforms.
                        </p>
                        <p><strong>Validation Results:</strong></p>
                        <ul>
                            <li>6 U.S. markets analyzed with validated predictions</li>
                            <li>3.8pp average error across core markets</li>
                        </ul>
                        <p style="margin-top: 15px;">
                            <strong>Core Formula:</strong><br>
                            ŒîU = 4(‚àíg √ó P) + D + 1.2S + F + 0.6E<br>
                            Market Share = 1 / (1 + e^(‚àíŒîU))
                        </p>
                        <p style="margin-top: 15px;">
                            <strong>Federal Reform Adjustments:</strong><br>
                            ‚Ä¢ 280E elimination: -$0.12/g price reduction (20-30% savings)<br>
                            ‚Ä¢ SAFE Banking: +0.15 convenience boost
                        </p>
                        <p style="margin-top: 20px;">
                            <a href="https://www.dankreports.com/cbdt-framework/" 
                               target="_blank" 
                               rel="noopener noreferrer"
                               style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.2s ease;">
                                üìñ How to Use This Calculator
                            </a>
                        </p>
                    </div>
                </div>
                
                <div class="section">
                    <h2>State-by-State Analysis</h2>
                    <div class="info-section">
                        <p style="margin-bottom: 15px;">
                            Explore detailed cannabis market analysis using the BMDE. Currently available:
                        </p>
                        <select id="stateSelector" style="width: 100%; padding: 12px; font-size: 1em; border-radius: 8px; border: 2px solid #667eea; margin-bottom: 10px;">
                            <option value="">Select a state...</option>
                            <option value="florida">‚úì Florida</option>
                            <option value="oregon">‚úì Oregon</option>
                            <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                            <option disabled value="">Alabama (Coming Soon)</option>
                            <option disabled value="">Alaska (Coming Soon)</option>
                            <option disabled value="">Arizona (Coming Soon)</option>
                            <option disabled value="">Arkansas (Coming Soon)</option>
                            <option disabled value="">California (Coming Soon)</option>
                            <option disabled value="">Colorado (Coming Soon)</option>
                            <option disabled value="">Connecticut (Coming Soon)</option>
                            <option disabled value="">Delaware (Coming Soon)</option>
                            <option disabled value="">Georgia (Coming Soon)</option>
                            <option disabled value="">Hawaii (Coming Soon)</option>
                            <option disabled value="">Idaho (Coming Soon)</option>
                            <option disabled value="">Illinois (Coming Soon)</option>
                            <option disabled value="">Indiana (Coming Soon)</option>
                            <option disabled value="">Iowa (Coming Soon)</option>
                            <option disabled value="">Kansas (Coming Soon)</option>
                            <option disabled value="">Kentucky (Coming Soon)</option>
                            <option disabled value="">Louisiana (Coming Soon)</option>
                            <option disabled value="">Maine (Coming Soon)</option>
                            <option disabled value="">Maryland (Coming Soon)</option>
                            <option disabled value="">Massachusetts (Coming Soon)</option>
                            <option disabled value="">Michigan (Coming Soon)</option>
                            <option disabled value="">Minnesota (Coming Soon)</option>
                            <option disabled value="">Mississippi (Coming Soon)</option>
                            <option disabled value="">Missouri (Coming Soon)</option>
                            <option disabled value="">Montana (Coming Soon)</option>
                            <option disabled value="">Nebraska (Coming Soon)</option>
                            <option disabled value="">Nevada (Coming Soon)</option>
                            <option disabled value="">New Hampshire (Coming Soon)</option>
                            <option disabled value="">New Jersey (Coming Soon)</option>
                            <option disabled value="">New Mexico (Coming Soon)</option>
                            <option disabled value="">New York (Coming Soon)</option>
                            <option disabled value="">North Carolina (Coming Soon)</option>
                            <option disabled value="">North Dakota (Coming Soon)</option>
                            <option disabled value="">Ohio (Coming Soon)</option>
                            <option disabled value="">Oklahoma (Coming Soon)</option>
                            <option disabled value="">Pennsylvania (Coming Soon)</option>
                            <option disabled value="">Rhode Island (Coming Soon)</option>
                            <option disabled value="">South Carolina (Coming Soon)</option>
                            <option disabled value="">South Dakota (Coming Soon)</option>
                            <option disabled value="">Tennessee (Coming Soon)</option>
                            <option disabled value="">Texas (Coming Soon)</option>
                            <option disabled value="">Utah (Coming Soon)</option>
                            <option disabled value="">Vermont (Coming Soon)</option>
                            <option disabled value="">Virginia (Coming Soon)</option>
                            <option disabled value="">Washington (Coming Soon)</option>
                            <option disabled value="">West Virginia (Coming Soon)</option>
                            <option disabled value="">Wisconsin (Coming Soon)</option>
                            <option disabled value="">Wyoming (Coming Soon)</option>
                        </select>
                        <button onclick="goToStateAnalysis()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer;">
                            View State Analysis
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="citation">
            <h3>About</h3>
            <p>
                Black Market Death Equation (BMDE)<br>
                Developed by Daniel Kief
            </p>
            <p style="margin-top: 20px;">
                <a href="https://www.dankreports.com" target="_blank">Dan K Reports</a> | 
                <a href="/cdn-cgi/l/email-protection#086c6966616d64637a6d78677a7c7b486f65696164266b6765"><span class="__cf_email__" data-cfemail="8aeeebe4e3efe6e1f8effae5f8fef9caede7ebe3e6a4e9e5e7">[email&#160;protected]</span></a>
            </p>
        </div>
    </div>
    
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // Real BMDE Formula from Harvard Dataverse
        // ŒîU = 4(‚àíg) + D + 1.2S + F + 0.6E ‚àí 0.8F_frag
        // Market Share = 1 / (1 + e^(‚àíŒîU))
        
        // Federal reform impacts (validated estimates)
        const REFORM_280E_PRICE_REDUCTION = -0.12; // $0.12/g price reduction when 280E eliminated (20-30% savings)
        const REFORM_SAFE_BANKING_CONVENIENCE = 0.15; // +0.15 convenience boost from banking access
        
        function calculate() {
            // Get base lever values
            let g = parseFloat(document.getElementById('priceGap').value);
            const D = parseFloat(document.getElementById('density').value);
            const S = parseFloat(document.getElementById('safety').value);
            let F = parseFloat(document.getElementById('convenience').value);
            const E = parseFloat(document.getElementById('enforcement').value);
            const F_frag = parseFloat(document.getElementById('fragmentation').value);
            
            // Check federal reforms
            const has280ERemoval = document.getElementById('remove280E').checked;
            const hasSafeBanking = document.getElementById('safeBanking').checked;
            
            // Calculate baseline (before reforms)
            const baselineDeltaU = 4 * (-g) + D + 1.2 * S + F + 0.6 * E;
            const baselineMarketShare = 1 / (1 + Math.exp(-baselineDeltaU));
            
            // Apply federal reform impacts
            if (has280ERemoval) {
                g += REFORM_280E_PRICE_REDUCTION; // Makes legal cannabis cheaper
            }
            if (hasSafeBanking) {
                F = Math.min(1, F + REFORM_SAFE_BANKING_CONVENIENCE); // Boosts convenience
            }
            
            // Update displays
            document.getElementById('priceDisplay').textContent = '$' + g.toFixed(2);
            document.getElementById('densityDisplay').textContent = D.toFixed(2);
            document.getElementById('safetyDisplay').textContent = S.toFixed(2);
            document.getElementById('convenienceDisplay').textContent = F.toFixed(2);
            document.getElementById('enforcementDisplay').textContent = E.toFixed(2);
            document.getElementById('fragDisplay').textContent = F_frag.toFixed(2);
            
            // Calculate utility score (ŒîU) with reforms
            const deltaU = 4 * (-g) + D + 1.2 * S + F + 0.6 * E;
            
            // Calculate market share using logistic function
            const marketShare = 1 / (1 + Math.exp(-deltaU));
            const marketSharePercent = (marketShare * 100).toFixed(0);
            
            // Update results
            document.getElementById('marketShare').textContent = marketSharePercent + '%';
            document.getElementById('utilityScore').textContent = deltaU.toFixed(2);
            
            // Show/hide federal reform impact box
            const reformBox = document.getElementById('reformImpactBox');
            if (has280ERemoval || hasSafeBanking) {
                reformBox.classList.add('active');
                
                // Calculate improvement
                const improvement = ((marketShare - baselineMarketShare) * 100).toFixed(1);
                const baselinePercent = (baselineMarketShare * 100).toFixed(0);
                
                // Update reform impact text
                let reformText = 'Federal reforms improve market competitiveness:<br><br>';
                if (has280ERemoval) {
                    reformText += '‚Ä¢ <strong>280E Elimination:</strong> Operators can deduct ordinary expenses, enabling 20-30% consumer price reductions. This significantly improves legal price competitiveness.<br>';
                }
                if (hasSafeBanking) {
                    reformText += '‚Ä¢ <strong>SAFE Banking:</strong> Banking access reduces cash-only costs and enables digital payments, improving convenience by 15-25%.<br>';
                }
                reformText += `<br>Combined impact: <strong>+${improvement} percentage points</strong> in legal market share.`;
                
                document.getElementById('reformImpactText').innerHTML = reformText;
                document.getElementById('beforeReform').textContent = baselinePercent + '%';
                document.getElementById('afterReform').textContent = marketSharePercent + '%';
            } else {
                reformBox.classList.remove('active');
            }
            
            // Update interpretation
            let interpretation = '';
            if (marketShare >= 0.85) {
                interpretation = 'üéØ Excellent policy design! This configuration achieves 85%+ legal market capture, effectively displacing the illicit market.';
            } else if (marketShare >= 0.70) {
                interpretation = '‚úÖ Strong performance. This policy framework captures 70-84% of the market, with room for optimization.';
            } else if (marketShare >= 0.50) {
                interpretation = '‚ö†Ô∏è Moderate success. Legal market captures 50-69% share. Consider improving price competitiveness, access density, or convenience factors.';
            } else if (marketShare >= 0.30) {
                interpretation = '‚ùå Weak performance. Legal market captures only 30-49% share. Significant policy improvements needed across multiple levers.';
            } else {
                interpretation = 'üö´ Poor policy design. Legal market captures less than 30% share. Major reforms required to price gap, access, or quality standards.';
            }
            
            // Add federal reform suggestion if not enabled
            if (!has280ERemoval && !hasSafeBanking && marketShare < 0.85) {
                interpretation += ' Federal reforms (280E elimination, SAFE Banking) could significantly improve outcomes.';
            }
            
            document.getElementById('interpretation').textContent = interpretation;
        }
        
        // Preset button functions using real validated state data
        function loadIllinoisPreset() {
            document.getElementById('priceGap').value = 0.50; // Capped at slider max (actual 56%)
            document.getElementById('density').value = 0.16; // Adjusted to hit 46% with capped price
            document.getElementById('safety').value = 0.85; // Upgraded from 0.4
            document.getElementById('convenience').value = 0.30; // Upgraded from 0.2
            document.getElementById('enforcement').value = 0.60;
            document.getElementById('fragmentation').value = 0;
            document.getElementById('remove280E').checked = false;
            document.getElementById('safeBanking').checked = false;
            calculate();
        }
        
        function loadColoradoPreset() {
            document.getElementById('priceGap').value = 0; // $5 parity
            document.getElementById('density').value = 0.79; // Adjusted to hit 91%
            document.getElementById('safety').value = 0.70; // 0.7/1.0 very competitive
            document.getElementById('convenience').value = 0.50; // 0.5/1.0 mature
            document.getElementById('enforcement').value = 0.30; // 0.3/1.0 moderate
            document.getElementById('fragmentation').value = 0;
            document.getElementById('remove280E').checked = false;
            document.getElementById('safeBanking').checked = false;
            calculate();
        }
        
        function loadOregonPreset() {
            document.getElementById('priceGap').value = -0.21; // Legal slightly cheaper
            document.getElementById('density').value = 0.75;
            document.getElementById('safety').value = 0.71;
            document.getElementById('convenience').value = 0.65;
            document.getElementById('enforcement').value = 1.00; // Maxed out
            document.getElementById('fragmentation').value = 0;
            document.getElementById('remove280E').checked = false;
            document.getElementById('safeBanking').checked = false;
            calculate();
        }
        
        function loadWashingtonPreset() {
            document.getElementById('priceGap').value = 0.27; // $7 vs $5.50 = 27% premium
            document.getElementById('density').value = 0.60;
            document.getElementById('safety').value = 0.85; // Upgraded from 0.5
            document.getElementById('convenience').value = 0.30;
            document.getElementById('enforcement').value = 0.50;
            document.getElementById('fragmentation').value = 0;
            document.getElementById('remove280E').checked = false;
            document.getElementById('safeBanking').checked = false;
            calculate();
        }
        
        function loadFloridaPreset() {
            document.getElementById('priceGap').value = 0.32;
            document.getElementById('density').value = -0.30;
            document.getElementById('safety').value = 0.85; // Upgraded from 0.4
            document.getElementById('convenience').value = -0.50; // Medical barriers
            document.getElementById('enforcement').value = 0.60;
            document.getElementById('fragmentation').value = 0;
            document.getElementById('remove280E').checked = false;
            document.getElementById('safeBanking').checked = false;
            calculate();
        }
        
        function resetToDefaults() {
            document.getElementById('priceGap').value = 0;
            document.getElementById('density').value = 0.5;
            document.getElementById('safety').value = 0.5;
            document.getElementById('convenience').value = 0.5;
            document.getElementById('enforcement').value = 0.5;
            document.getElementById('fragmentation').value = 0;
            document.getElementById('remove280E').checked = false;
            document.getElementById('safeBanking').checked = false;
            calculate();
        }
        
        // Initial calculation
        calculate();
        
        // State analysis navigation function
        function goToStateAnalysis() {
            const selector = document.getElementById('stateSelector');
            const state = selector.value;
            
            if (!state) return;
            
            // Only Florida and Oregon have published analyses
            const stateUrls = {
                'florida': 'https://www.dankreports.com/florida-recreational-cannabis-forecast/',
                'oregon': 'https://www.dankreports.com/oregon-cannabis-market-analysis-success/'
            };
            
            if (stateUrls[state]) {
                window.open(stateUrls[state], '_blank');
            }
            // Do nothing for other states - they're disabled in the dropdown
        }
    </script>
</body>
</html>
